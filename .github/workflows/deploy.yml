name: Deploy to VPS

on:
  push:
    branches:
      - main # lub master, zmieÅ„ jeÅ›li masz inny branch
  workflow_dispatch: # moÅ¼liwoÅ›Ä‡ rÄ™cznego uruchomienia

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Navigate to project directory
        run: cd /home/debian/fastapi-svelte-fileshare

      - name: Stash local changes
        working-directory: /home/debian/fastapi-svelte-fileshare
        run: |
          echo "ğŸ’¾ Stashing local changes..."
          git stash push -m "Auto-stash before deploy $(date +%Y-%m-%d_%H:%M:%S)"

          # Opcjonalnie: backup caÅ‚ego katalogu
          echo "ğŸ“¦ Creating backup..."
          tar -czf /home/debian/backups/fastapi-backup-$(date +%Y%m%d-%H%M%S).tar.gz \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.git' \
            -C /home/debian fastapi-svelte-fileshare 2>/dev/null || echo "âš ï¸ Backup skipped"

      - name: Pull latest changes
        working-directory: /home/debian/fastapi-svelte-fileshare
        run: |
          echo "ğŸ“¥ Pulling latest changes..."
          git pull --rebase

      - name: Restore stashed changes (if any)
        working-directory: /home/debian/fastapi-svelte-fileshare
        if: always()
        run: |
          if git stash list | grep -q "Auto-stash"; then
            echo "â™»ï¸ Restoring stashed changes..."
            git stash pop || echo "âš ï¸ Could not restore stash (conflicts?)"
          else
            echo "â„¹ï¸ No stashed changes to restore"
          fi

      - name: Rebuild and restart containers
        working-directory: /home/debian/fastapi-svelte-fileshare
        run: |
          echo "ğŸ³ Rebuilding containers..."
          docker compose down
          docker compose up -d --build

          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f

      - name: Show container status
        working-directory: /home/debian/fastapi-svelte-fileshare
        run: |
          echo "âœ… Deployment completed!"
          echo ""
          echo "ğŸ“Š Container status:"
          docker compose ps

          echo ""
          echo "ğŸ“‹ Recent logs:"
          docker compose logs --tail=20

      - name: Health check
        working-directory: /home/debian/fastapi-svelte-fileshare
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10

          # SprawdÅº czy kontenery dziaÅ‚ajÄ…
          if ! docker compose ps | grep -q "Up"; then
            echo "âŒ Containers are not running!"
            docker compose logs
            exit 1
          fi

          echo "âœ… All services are healthy!"
